name: Build (ROS2)

on:
  push:
    branches:
      - master
      - main
      - 'fix/*'
      - 'feature/*'
  pull_request:

jobs:
  setup-and-run-ci:
    name: ros-ci
    runs-on: [self-hosted, Linux, x64]
    permissions:
      contents: read
      pull-requests: read
    container:
      image: riibotics/ros_dev:humble
      credentials:
        username: ${{ secrets.RIIBOTICS_DEV_DOCKERHUB_USERNAME }}
        password: ${{ secrets.RIIBOTICS_DEV_DOCKERHUB_PASSWORD }}
      options: -u root
    env:
      ROS_DISTRO: humble
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.TIM_ROBOTICS_REPOS_RO_TOKEN }}
          persist-credentials: false

      - name: Install SSH key (for private submodules)
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.TIM_ROBOTICS_REPOS_SSH_PRIVATE_KEY }}
          name: id_rsa
          known_hosts: unnecessary
          if_key_exists: replace

      - name: Install lcov
        run: |
          apt-get update
          apt-get install -y lcov

      - name: Install ROS2 dependencies
        run: |
          rosdep update || (rosdep init && rosdep update)
          cd linux/Sample/ros2/lx_camera_node_ws
          rosdep install --from-paths src --ignore-src -r -y

      - name: Install SDK headers/libs to /opt
        run: |
          mkdir -p /opt/Lanxin-MRDVS/include /opt/Lanxin-MRDVS/lib
          cp -r linux/SDK/include/* /opt/Lanxin-MRDVS/include/
          cp -r linux/SDK/lib/linux_x64/* /opt/Lanxin-MRDVS/lib/

      - name: Build (colcon)
        run: |
          source /opt/ros/$ROS_DISTRO/setup.bash
          cd linux/Sample/ros2/lx_camera_node_ws
          colcon build --event-handlers console_direct+ --symlink-install

      - name: Cleanup
        if: always()
        run: |
          rm -rf /opt/Lanxin-MRDVS
          rm -rf linux/Sample/ros2/lx_camera_node_ws/build
          rm -rf linux/Sample/ros2/lx_camera_node_ws/install
          rm -rf linux/Sample/ros2/lx_camera_node_ws/log
